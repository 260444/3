# 后端代码整改清单

## 📋 整体架构问题

### 1. 依赖注入不完善 ❌
**问题**: 当前手动初始化依赖，缺乏依赖注入框架
**整改建议**: 引入 Wire 或手动实现依赖注入容器

### 2. 错误处理不统一 ❌
**问题**: 错误处理分散，缺乏统一的错误响应格式
**整改建议**: 实现全局错误处理中间件和统一错误响应结构

### 3. 缺乏全局异常恢复机制 ❌
**问题**: 没有 panic 恢复机制，可能导致服务崩溃
**整改建议**: 添加 Recovery 中间件

## 🔧 具体整改项

### 📁 包结构调整
- [ ] 按 Clean Architecture 重新组织包结构
- [ ] 分离 DTO 层和 Entities 层
- [ ] 统一接口定义位置

### 🔄 依赖注入
- [ ] 引入 google/wire 依赖注入工具
- [ ] 或实现手动依赖注入容器
- [ ] 统一依赖初始化方式

### ⚠️ 错误处理
- [ ] 定义统一错误响应结构体
- [ ] 实现全局错误处理中间件
- [ ] 统一错误日志记录格式
- [ ] 替换所有的 fmt.Println 为结构化日志

### 🛡️ 安全性增强
- [ ] 实现请求验证中间件
- [ ] 添加输入参数校验
- [ ] 完善 JWT token 黑名单机制
- [ ] 加强 SQL 注入防护

### 📊 日志规范化
- [ ] 统一日志字段命名
- [ ] 添加请求追踪 ID
- [ ] 实现分级日志记录
- [ ] 移除所有 fmt.Print 输出

### 🧪 测试覆盖
- [ ] 添加单元测试框架 (Testify)
- [ ] 编写核心业务逻辑测试
- [ ] 实现 Repository 层 Mock 测试
- [ ] 添加集成测试

## 📝 详细整改方案

### 1. 统一错误处理结构

```go
// 定义标准响应格式
type APIResponse struct {
    Success bool        `json:"success"`
    Message string      `json:"message"`
    Data    interface{} `json:"data,omitempty"`
    Error   string      `json:"error,omitempty"`
}

// 自定义业务错误
type BusinessError struct {
    Code    int    `json:"code"`
    Message string `json:"message"`
}

func (e *BusinessError) Error() string {
    return e.Message
}
```

### 2. 全局中间件增强

```go
// Recovery 中间件
func RecoveryMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        defer func() {
            if err := recover(); err != nil {
                logger.Logger.Error("panic recovered",
                    zap.Any("error", err),
                    zap.String("stack", string(debug.Stack())))
                
                c.JSON(http.StatusInternalServerError, APIResponse{
                    Success: false,
                    Message: "内部服务器错误",
                    Error:   "服务器内部错误，请稍后重试",
                })
                c.Abort()
            }
        }()
        c.Next()
    }
}

// 统一错误处理中间件
func ErrorHandlingMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        c.Next()
        
        if len(c.Errors) > 0 {
            err := c.Errors.Last()
            // 处理不同类型的错误...
        }
    }
}
```

### 3. 依赖注入改造

```go
// 定义依赖注入容器接口
type Container interface {
    GetUserRepository() UserRepository
    GetUserService() UserService
    // ... 其他依赖
}

// 实现依赖注入
func InitializeContainer(db *gorm.DB, redisClient *redis.Client) (Container, error) {
    // 初始化各种依赖...
    return &containerImpl{
        userRepo: NewUserRepository(db),
        // ...
    }, nil
}
```

## 🎯 优先级排序

### 高优先级 (必须整改)
1. 统一错误处理和响应格式 ✅
2. 添加全局异常恢复机制 ✅
3. 规范化日志输出 ✅
4. 完善输入验证 ✅

### 中优先级 (建议整改)
1. 实现依赖注入 ✅
2. 添加单元测试 ✅
3. 安全性增强 ✅

### 低优先级 (可选整改)
1. 性能监控和指标收集
2. 更完善的文档生成
3. API 版本管理

## 📊 整改进度跟踪

| 项目 | 状态 | 负责人 | 预计完成时间 |
|------|------|--------|--------------|
| 统一错误处理 | ⏳ 待开始 | - | - |
| 全局异常恢复 | ⏳ 待开始 | - | - |
| 日志规范化 | ⏳ 待开始 | - | - |
| 依赖注入改造 | ⏳ 待开始 | - | - |
| 单元测试添加 | ⏳ 待开始 | - | - |

---
**备注**: 此清单基于 Clean Architecture 和项目规范要求制定，建议按优先级逐步实施整改。