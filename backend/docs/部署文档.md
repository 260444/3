# 部署文档

## 1. 环境准备

### 1.1 服务器环境要求
- 操作系统：Linux (推荐 Ubuntu 18.04+/CentOS 7+)
- 内存：至少 2GB
- 硬盘：至少 10GB 可用空间

### 1.2 软件依赖
- Go 1.24.0 或更高版本
- MySQL 5.7 或更高版本
- Redis 5.0 或更高版本
- Node.js 16.x 或更高版本 (仅开发环境)
- Nginx 1.18 或更高版本 (生产环境)

## 2. 数据库配置

### 2.1 创建数据库
```sql
CREATE DATABASE admin_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 2.2 创建数据库用户并授权
```sql
CREATE USER 'admin_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON admin_system.* TO 'admin_user'@'localhost';
FLUSH PRIVILEGES;
```

## 3. 后端部署

### 3.1 上传代码
```bash
# 创建项目目录
sudo mkdir -p /opt/golang-backend
sudo chown $USER:$USER /opt/golang-backend

# 上传后端代码到服务器
# (使用scp、git clone 或其他方式)
```

### 3.2 安装Go依赖
```bash
cd /opt/golang-backend/backend
go mod tidy
```

### 3.3 配置环境变量
编辑配置文件 `config/config.yaml`:
```yaml
server:
  port: ":8080"
  mode: "release"  # 生产环境使用 release
  read_timeout: 60
  write_timeout: 60

database:
  host: "localhost"
  port: 3306
  user: "admin_user"
  password: "your_secure_password"
  dbname: "admin_system"
  charset: "utf8mb4"

redis:
  addr: "localhost:6379"
  password: ""
  db: 0

jwt:
  secret: "your-production-secret-key"  # 使用强密钥
  timeout: 7200
```

### 3.4 构建后端
```bash
cd /opt/golang-backend/backend
go build -o backend main.go
```

### 3.5 创建系统服务
创建服务文件 `/etc/systemd/system/golang-backend.service`:
```ini
[Unit]
Description=Golang Backend Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/golang-backend/backend
ExecStart=/opt/golang-backend/backend/backend
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 3.6 启动后端服务
```bash
sudo systemctl daemon-reload
sudo systemctl enable golang-backend
sudo systemctl start golang-backend
```

## 4. 前端部署

### 4.1 上传代码
```bash
# 上传前端代码到服务器
# (使用scp、git clone 或其他方式)
```

### 4.2 安装依赖并构建
```bash
cd /opt/golang-backend/frontend
npm install
npm run build
```

## 5. Nginx配置

### 5.1 安装Nginx
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
```

### 5.2 配置Nginx
创建Nginx配置文件 `/etc/nginx/sites-available/admin-system`:
```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为实际域名

    # 前端静态文件
    location / {
        alias /opt/golang-backend/frontend/dist/;
        try_files $uri $uri/ /index.html;
        expires 1h;
        add_header Cache-Control "public, immutable";
    }

    # API代理到后端
    location /api/ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 验证码等其他API代理
    location /captcha/ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 5.3 启用站点
```bash
sudo ln -s /etc/nginx/sites-available/admin-system /etc/nginx/sites-enabled/
sudo nginx -t  # 检查配置是否正确
sudo systemctl restart nginx
```

## 6. SSL配置（可选但推荐）

### 6.1 使用Let's Encrypt获取SSL证书
```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

## 7. 安全配置

### 7.1 防火墙配置
```bash
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
```

### 7.2 MySQL安全配置
```bash
sudo mysql_secure_installation
```

## 8. 监控和日志

### 8.1 后端日志
后端日志文件位于 `backend/logs/app.log`

### 8.2 Nginx日志
- 访问日志: `/var/log/nginx/access.log`
- 错误日志: `/var/log/nginx/error.log`

### 8.3 查看服务状态
```bash
# 查看后端服务状态
sudo systemctl status golang-backend

# 查看Nginx状态
sudo systemctl status nginx

# 查看实时日志
sudo journalctl -u golang-backend -f
```

## 9. 备份策略

### 9.1 数据库备份
创建备份脚本 `backup-db.sh`:
```bash
#!/bin/bash
BACKUP_DIR="/backup/db"
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u admin_user -p'your_password' admin_system > $BACKUP_DIR/admin_system_$DATE.sql
```

### 9.2 代码备份
```bash
tar -czf /backup/code/golang-backend-$(date +%Y%m%d_%H%M%S).tar.gz /opt/golang-backend/
```

## 10. 更新部署

### 10.1 停止服务
```bash
sudo systemctl stop golang-backend
```

### 10.2 更新代码
```bash
# 备份当前版本
sudo cp -r /opt/golang-backend /opt/golang-backend-backup-$(date +%Y%m%d_%H%M%S)

# 更新代码
# (使用git pull或其他方式)

# 重新构建
cd /opt/golang-backend/backend
go build -o backend main.go
```

### 10.3 启动服务
```bash
sudo systemctl start golang-backend
```

## 11. 故障排除

### 11.1 服务无法启动
```bash
# 检查服务状态
sudo systemctl status golang-backend

# 查看详细日志
sudo journalctl -u golang-backend -e
```

### 11.2 端口被占用
```bash
# 检查端口占用
sudo netstat -tlnp | grep :8080
sudo netstat -tlnp | grep :80
```

### 11.3 数据库连接失败
- 确认MySQL服务是否运行
- 检查数据库配置是否正确
- 检查数据库用户权限