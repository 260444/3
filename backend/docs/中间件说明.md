# 中间件说明文档

## 概述

本文档介绍了后端项目中使用的各种中间件及其功能。

## 全局中间件 (global.go)

### 1. RecoveryMiddleware - 异常恢复中间件

**功能**: 捕获程序panic异常，记录详细日志并返回统一的错误响应。

**特点**:
- 自动捕获所有未处理的panic异常
- 记录完整的错误堆栈信息
- 返回标准化的错误响应格式
- 防止程序因异常而崩溃

**使用示例**:
```go
r.Use(middleware.RecoveryMiddleware())
```

### 2. ResponseWrapperMiddleware - 响应包装中间件

**功能**: 统一处理错误响应格式，将非标准的错误响应转换为标准格式。

**特点**:
- 自动识别4xx和5xx状态码的响应
- 将原始错误信息转换为标准的API响应格式
- 保持原有的HTTP状态码不变
- 支持多种常见错误类型的标准化处理

**标准响应格式**:
```json
{
  "success": false,
  "message": "错误描述信息",
  "error": "具体的错误内容"
}
```

**支持的状态码转换**:
- 400: 请求参数错误
- 401: 未授权访问
- 403: 权限不足
- 404: 资源不存在
- 429: 请求过于频繁
- 500+: 请求处理失败

### 3. RequestIDMiddleware - 请求ID中间件

**功能**: 为每个请求生成唯一的请求ID，便于追踪和调试。

**特点**:
- 自动生成唯一的请求标识符
- 在响应头中返回X-Request-ID
- 在请求上下文中存储request_id

## 认证和权限中间件 (middleware.go)

### 1. JWTAuthMiddleware - JWT认证中间件

**功能**: 验证JWT token的有效性并提取用户信息。

**验证流程**:
1. 检查Authorization头部是否存在
2. 验证Bearer token格式
3. 解析和验证JWT token
4. 将用户信息存储到上下文中

**上下文存储的信息**:
- userID: 用户ID
- username: 用户名
- ident: 用户标识符

### 2. CasbinMiddleware - 权限验证中间件

**功能**: 基于Casbin的RBAC权限控制系统。

**特性**:
- 支持RESTful API权限控制
- 自动处理用户访问自己信息的特殊情况
- 区分API请求和页面请求的不同响应方式
- API请求返回JSON错误，页面请求重定向到无权限页面

### 3. CORSMiddleware - 跨域中间件

**功能**: 处理跨域资源共享(CORS)请求。

**配置**:
- 允许所有域名访问(*)
- 支持常用HTTP方法
- 允许常见的请求头
- 支持携带凭证

## 日志和监控中间件

### LoggerToFile - 文件日志中间件

**功能**: 记录HTTP请求的详细日志信息到文件。

**记录的信息**:
- 请求方法和URI
- 响应状态码
- 客户端IP地址
- 请求处理时间
- User-Agent信息

## 使用建议

### 中间件注册顺序

建议按照以下顺序注册中间件：

```go
r.Use(gin.Logger())                    // Gin内置日志
r.Use(middleware.RecoveryMiddleware()) // 异常恢复（最先注册）
r.Use(middleware.ResponseWrapperMiddleware()) // 响应格式统一
r.Use(middleware.CORSMiddleware())     // 跨域处理
r.Use(middleware.JWTAuthMiddleware())  // JWT认证
r.Use(middleware.CasbinMiddleware())   // 权限验证
```

### 错误处理最佳实践

1. **优先使用标准响应函数**:
```go
// 推荐方式
response.Error(c, err)
response.ValidationError(c, "字段名", "错误信息")

// 避免直接使用
c.JSON(http.StatusBadRequest, gin.H{"error": "错误信息"})
```

2. **利用中间件自动处理**:
```go
// 控制器中只需设置状态码，中间件会自动格式化响应
c.AbortWithStatus(http.StatusBadRequest)
```

## 测试

项目包含了中间件的单元测试，可以通过以下命令运行：

```bash
cd backend
go test -v middleware_test.go
```

测试覆盖了:
- ResponseWrapperMiddleware的功能验证
- RecoveryMiddleware的异常处理能力
- 响应格式的标准化转换

## 常见问题

### Q: 为什么有些错误响应没有被标准化？

A: 中间件只会处理状态码为4xx或5xx的响应，并且会检查Content-Type。如果需要确保所有错误都被标准化，建议在控制器中使用`response`包提供的标准函数。

### Q: 如何自定义错误消息？

A: 可以通过修改`ResponseWrapperMiddleware`中的状态码映射关系，或者在控制器中直接使用`response.ErrorWithCode()`函数。

### Q: 中间件会影响性能吗？

A: 这些中间件的设计考虑了性能影响，RecoveryMiddleware只在发生panic时执行，ResponseWrapperMiddleware只处理错误状态码，正常请求不会受到影响。