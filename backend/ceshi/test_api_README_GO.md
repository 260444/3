# Go API 测试脚本使用说明

## 概述

本项目提供了 Go 语言版本的 API 测试脚本 (`test_api.go`)，用于测试所有后端 API 接口。

## 测试覆盖范围

脚本会测试以下 API 接口：

### 公开接口（无需认证）
- ✓ 获取验证码
- ✓ 用户登录
- ✓ 退出登录

### 用户管理（需要认证）
- ✓ 创建用户
- ✓ 获取用户列表

### 用户管理（需要认证）
- ✓ 获取用户列表
- ✓ 获取用户信息
- ✓ 更新用户信息
- ✓ 更新用户状态
- ✓ 修改密码

### 角色管理（需要认证）
- ✓ 创建角色
- ✓ 获取角色列表
- ✓ 获取角色详情
- ✓ 更新角色

### 菜单管理（需要认证）
- ✓ 创建菜单
- ✓ 获取菜单树
- ✓ 获取所有菜单
- ✓ 获取菜单详情
- ✓ 更新菜单

### 权限管理（需要认证）
- ✓ 为角色分配菜单权限
- ✓ 获取角色菜单权限
- ✓ 添加 Casbin 策略
- ✓ 获取角色 Casbin 策略
- ✓ 获取所有 Casbin 策略
- ✓ 移除 Casbin 策略
- ✓ 移除角色菜单权限

### 操作日志（需要认证）
- ✓ 获取操作日志列表

## 前置条件

### 1. 启动后端服务

确保后端服务已启动并运行在 `http://localhost:8080`

```bash
# 方式 1: 直接运行
go run main.go

# 方式 2: 构建后运行
go build -o backend main.go
./backend
```

### 2. 确保 Go 环境已安装

```bash
go version
```

### 3. 确保数据库已初始化

确保 MySQL 数据库已创建并初始化相关表结构。

### 4. 导入测试数据

在运行测试脚本之前，需要先导入测试数据：

```bash
# 使用 MySQL 客户端导入测试数据
mysql -u root -p admin_system < docs/test_data.sql

# 或者在 MySQL 命令行中执行
mysql -u root -p
use admin_system;
source docs/test_data.sql;
```

## 使用方法

### 运行测试脚本

```bash
# 进入测试目录
cd ceshi

# 运行测试
go run test_api.go

# 或者先编译再运行
go build test_api.go
./test_api
```

## 测试流程

脚本会按照以下顺序执行测试：

1. **检查服务器状态** - 验证后端服务是否正常运行
2. **公开接口测试** - 测试无需认证的接口（验证码、登录）
3. **认证接口测试** - 使用管理员账号登录后测试需要认证的接口
4. **清理测试数据** - 删除测试过程中创建的数据（可选，默认注释）

## 测试数据说明

脚本需要以下前提条件：

### 1. 导入测试数据

在运行测试脚本之前，需要先导入测试数据：

```bash
# 使用 MySQL 客户端导入测试数据
mysql -u root -p admin_system < docs/test_data.sql

# 或者在 MySQL 命令行中执行
mysql -u root -p
use admin_system;
source docs/test_data.sql;
```

### 2. 管理员账号

测试数据中包含以下管理员账号：

- **用户名**: `admin`
- **密码**: `123456`

如果使用不同的账号，请修改 `test_api.go` 中的 `Username` 和 `Password` 字段。

### 3. 测试数据概览

导入的测试数据包括：

- **角色**: 5 个（超级管理员、管理员、普通用户、访客、测试角色）
- **菜单**: 15 个（4 个一级菜单 + 11 个二级菜单）
- **用户**: 10 个（1 个超级管理员、2 个管理员、6 个普通用户、1 个禁用用户）
- **操作日志**: 20 条

脚本会自动创建以下测试数据：

- **测试用户**: `testuser_<timestamp>`
  - 密码: `Test123456`
  - 邮箱: `testuser_<timestamp>@example.com`
  - 昵称: 测试用户

- **测试角色**: `测试角色_<timestamp>`
  - 描述: 这是一个测试角色

- **测试菜单**: `test_menu_<timestamp>`
  - 标题: 测试菜单
  - 路径: /test

## 输出说明

### 成功输出示例

```
✓ 获取验证码 - PASS
  状态码: 200
  响应: {
    "message": "验证码生成成功",
    "data": {
      "id": "xxx",
      "image": "data:image/png;base64,..."
    }
  }
```

### 失败输出示例

```
✗ 用户登录 - FAIL
  状态码: 401
  响应: {
    "error": "用户名或密码错误"
  }
```

### 测试结果汇总

```
============================================================
测试结果汇总
============================================================
总计: 23 个测试
通过: 20 个
失败: 3 个
成功率: 87.0%
============================================================
```

## 配置说明

### 修改服务器地址

如果后端服务运行在其他地址或端口，可以修改脚本中的配置：

```go
const (
    BaseURL  = "http://your-server:port"  // 修改这里
    APIBase  = BaseURL + "/api/v1"
    Timeout  = 10 * time.Second
)
```

### 修改超时时间

```go
const (
    Timeout  = 10 * time.Second  // 修改超时时间
)
```

## 常见问题

### 1. 无法连接到服务器

**错误信息**: `✗ 无法连接到服务器 http://localhost:8080`

**解决方案**:
- 确认后端服务已启动
- 检查端口是否正确
- 检查防火墙设置

### 2. 测试失败率高

**可能原因**:
- 数据库未正确初始化
- 数据库连接失败
- JWT 密钥配置错误
- Redis 连接失败（可选）

**解决方案**:
- 检查 `config/config.yaml` 配置
- 查看后端日志 `logs/app.log`
- 确认数据库表结构正确

### 3. 用户名已存在

**错误信息**: 创建用户时提示用户名已存在

**解决方案**:
- 脚本使用时间戳生成唯一用户名，理论上不会重复
- 如果遇到此问题，可以手动删除数据库中的测试用户

### 4. 管理员账号登录失败

**错误信息**: 用户登录时提示用户名或密码错误

**解决方案**:
- 确认已导入测试数据 SQL 文件
- 确认数据库中已创建管理员账号
- 检查用户名和密码是否正确（默认：admin/123456）
- 如果使用不同的账号，请修改 `test_api.go` 中的配置

### 5. 测试数据导入失败

**错误信息**: 导入 SQL 文件时出现错误

**解决方案**:
- 确认 MySQL 数据库 `admin_system` 已创建
- 确认数据库表结构已正确创建
- 检查 SQL 文件路径是否正确
- 检查数据库用户权限

## 扩展测试

### 添加新的测试用例

在 `test_api.go` 中添加新的测试函数：

```go
// 测试新的 API
func testYourNewAPI() {
    data := map[string]interface{}{
        "param1": "value1",
        "param2": "value2",
    }

    resp, err := makeRequest("POST", "/your-endpoint", data, getAuthHeaders())
    if err != nil {
        printResult("新 API 测试", false, nil, err)
        return
    }
    defer resp.Body.Close()

    passed := resp.StatusCode == 200
    printResult("新 API 测试", passed, resp, nil)
}
```

然后在 `runTests()` 函数中调用：

```go
func runTests() {
    // ... 其他测试
    testYourNewAPI()  // 添加这一行
}
```

## 注意事项

1. **测试数据清理**: 脚本默认不清理测试数据，如需清理请取消注释 `runTests()` 函数末尾的清理代码
2. **并发测试**: 脚本是顺序执行的，不支持并发测试
3. **性能测试**: 此脚本仅用于功能测试，不适用于性能测试
4. **生产环境**: 请勿在生产环境运行此测试脚本
5. **数据安全**: 测试脚本会创建和删除数据，请确保在测试环境中运行

## 技术支持

如遇到问题，请检查：
1. 后端服务日志: `logs/app.log`
2. 数据库连接状态
3. 网络连接状态
4. 配置文件: `config/config.yaml`

## 版本信息

- **当前版本**: 1.0.0
- **支持的后端版本**: 1.0.0+
- **最后更新**: 2026-01-18
- **Go 版本要求**: 1.16+

## 与 Python 版本的对比

| 特性 | Go 版本 | Python 版本 |
|------|---------|-------------|
| 执行速度 | 快 | 中等 |
| 依赖管理 | 标准库 | 需要 requests |
| 跨平台 | 优秀 | 优秀 |
| 并发支持 | 原生支持 | 需要额外代码 |
| 类型安全 | 强类型 | 动态类型 |
| 部署方便性 | 单一可执行文件 | 需要 Python 环境 |

## 测试脚本结构

```
test_api.go
├── 配置常量
├── 数据结构定义
│   ├── TestData (测试数据存储)
│   ├── APIResponse (API 响应)
│   └── PaginatedResponse (分页响应)
├── 全局变量
├── 主函数 (main)
├── 工具函数
│   ├── checkServer (检查服务器状态)
│   ├── runTests (运行所有测试)
│   ├── makeRequest (发送 HTTP 请求)
│   ├── getAuthHeaders (获取认证头)
│   ├── printResult (打印测试结果)
│   └── printSummary (打印测试结果汇总)
└── 测试函数
    ├── 公开接口测试
    ├── 用户管理测试
    ├── 角色管理测试
    ├── 菜单管理测试
    ├── 权限管理测试
    ├── 操作日志测试
    └── 清理测试数据
```